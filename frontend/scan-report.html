<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scan Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, system-ui, sans-serif;
      background: #f6f7fb;
      min-height: 100vh;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      padding: 20px;
      width: 100%;
      max-width: 1000px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      color: #1f2a44;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    label {
      font-size: 13px;
      color: #555;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    input[type="date"] {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 13px;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 380px;
    }

    /* Skeleton loader */
    .skeleton {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        90deg,
        #f0f0f0 25%,
        #e4e4e4 37%,
        #f0f0f0 63%
      );
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius: 12px;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    @media (max-width: 600px) {
      .chart-wrapper {
        height: 300px;
      }
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="header">
      <h2>Scans</h2>
      <div class="controls">
        <label>
          From
          <input type="date" id="fromDate">
        </label>
        <label>
          To
          <input type="date" id="toDate">
        </label>
      </div>
    </div>

    <div class="chart-wrapper">
      <div class="skeleton" id="skeleton"></div>
      <canvas id="scanChart"></canvas>
    </div>
  </div>

  <!-- Shared -->
  <script src="config.js"></script>
  <script src="utils.js"></script>
  <script src="api.js"></script>

  <script>
    const fromInput = document.getElementById("fromDate");
    const toInput = document.getElementById("toDate");
    const skeleton = document.getElementById("skeleton");
    const ctx = document.getElementById("scanChart").getContext("2d");

    let chart;

    function formatDateISO(d) {
      return d.toISOString().slice(0, 10);
    }

    function getDateRange(start, end) {
      const dates = [];
      const d = new Date(start);
      while (d <= end) {
        dates.push(new Date(d));
        d.setDate(d.getDate() + 1);
      }
      return dates;
    }

    async function loadReport() {
      if (!fromInput.value || !toInput.value) return;

      const from = new Date(fromInput.value);
      const to = new Date(toInput.value);

      if (from > to) return;

      skeleton.style.display = "block";

      const days = getDateRange(from, to);

      const results = await Promise.all(
        days.map(d =>
          fetchLocationsByDate(formatDateISO(d))
            .then(rows => rows.length)
            .catch(() => 0)
        )
      );

      const labels = days.map(d =>
        d.toLocaleDateString("en-GB", { day: "2-digit", month: "short" })
      );

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            data: results,
            backgroundColor: "#3b5bdb",
            borderRadius: 6,
            barThickness: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.parsed.y} scans`
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: "#666", font: { size: 12 } }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: "#eee",
                drawBorder: false
              },
              ticks: {
                color: "#666",
                font: { size: 12 },
                precision: 0
              }
            }
          }
        }
      });

      skeleton.style.display = "none";
    }

    /* Default: last 7 days */
    const today = new Date();
    const weekAgo = new Date();
    weekAgo.setDate(today.getDate() - 6);

    fromInput.value = formatDateISO(weekAgo);
    toInput.value = formatDateISO(today);

    loadReport();

    fromInput.onchange = loadReport;
    toInput.onchange = loadReport;
  </script>
</body>
</html>
